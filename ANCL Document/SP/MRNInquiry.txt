IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[MRNAdvanceSearchForInquiry]') )
DROP PROCEDURE [dbo].[MRNAdvanceSearchForInquiry]
GO
-- =============================================
-- Author:		Mohammed Shanaz
-- Create date: 16/6/2019
-- Description:	MRN Inquiry Advance Search
-- =============================================
CREATE PROCEDURE [dbo].[MRNAdvanceSearchForInquiry] 
(
	@CompanyId AS INT,
	@searchBy  AS INT,
	@categoryId AS INT,
	@subDepartmentId AS INT,
	@searchText varchar(50)
) 
AS
BEGIN

	IF @searchBy=0
	BEGIN
		IF ( @categoryId >1 AND @subDepartmentId = 0 )
			BEGIN
			SELECT * FROM  dbo.MRN_MASTER MRN
			INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
			INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID = SUBDEP.SUB_DEPARTMENT_ID 
			WHERE MRN.ITEM_CATEGORY_ID = @categoryId
			ORDER BY MRN.MRN_ID DESC
			END
		ELSE IF (@categoryId = 0 AND @subDepartmentId > 0)
			BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN 
			INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
			INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID 
			WHERE  MRN.SUB_DEPARTMENT_ID = @subDepartmentId
			ORDER BY MRN.MRN_ID DESC
			END
		ELSE IF (@categoryId != 0 AND @subDepartmentId != 0)
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID 
            WHERE MRN.ITEM_CATEGORY_ID =@categoryId AND  MRN.SUB_DEPARTMENT_ID = @subDepartmentId
            ORDER BY MRN.MRN_ID DESC
		END
	END
	ELSE IF @searchBy=1
	BEGIN
		IF (@categoryId > 1 AND @subDepartmentId = 0)
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN
			INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
			INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID 
			WHERE MRN.ITEM_CATEGORY_ID = @categoryId AND MRN.MRN_ID like '%' + replace(@searchText, '%', '[%]') + '%' 
			ORDER BY MRN.MRN_ID DESC
		END
		ELSE IF (@categoryId = 0 AND @subDepartmentId > 0)
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID 
            WHERE  MRN.SUB_DEPARTMENT_ID = @subDepartmentId AND MRN.MRN_ID like '%' + replace(@searchText, '%', '[%]') + '%' 
            ORDER BY MRN.MRN_ID DESC
		END
		ELSE IF (@categoryId != 0 AND @subDepartmentId != 0)
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN 
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID
            WHERE MRN.MRN_ID like '%' + replace(@searchText, '%', '[%]') + '%' 
            AND  MRN.SUB_DEPARTMENT_ID = @subDepartmentId AND  MRN.ITEM_CATEGORY_ID =@categoryId
            ORDER BY MRN.MRN_ID DESC
		END
		ELSE
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN 
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID 
            WHERE MRN.MRN_ID like '%' + replace(@searchText, '%', '[%]') + '%' 
            ORDER BY MRN.MRN_ID DESC
		END
	END
	ELSE IF @searchBy=2 
	BEGIN
	 IF (@categoryId > 1 AND @subDepartmentId = 0)
		BEGIN
			 SELECT * FROM dbo.MRN_MASTER MRN 
			 INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
			 INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID
			 WHERE MRN.ITEM_CATEGORY_ID = @categoryId AND  CL.USER_NAME Like @searchText
			 ORDER BY MRN.MRN_ID DESC
		END
		ELSE IF (@categoryId = 0 AND @subDepartmentId > 0)
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN 
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID
            WHERE  MRN.SUB_DEPARTMENT_ID = @subDepartmentId AND  CL.USER_NAME Like  @searchText
            ORDER BY MRN.MRN_ID DESC
		END
		 ELSE IF (@categoryId != 0 AND @subDepartmentId != 0)
		 BEGIN
			 SELECT * FROM dbo.MRN_MASTER MRN
			 INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
			 INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID
			 WHERE CL.USER_NAME Like  @searchText AND  MRN.SUB_DEPARTMENT_ID = @subDepartmentId AND  MRN.ITEM_CATEGORY_ID =@categoryId
			 ORDER BY MRN.MRN_ID DESC
		 END
		 ELSE
		 BEGIN
			 SELECT * FROM dbo.MRN_MASTER MRN
			 INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
			 INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID
			 WHERE CL.USER_NAME Like @searchText
			 ORDER BY MRN.MRN_ID DESC
		 END
	END
	ELSE IF @searchBy=3 
	BEGIN
		IF (@categoryId > 1 AND @subDepartmentId = 0)
		BEGIN
			SELECT * FROM  dbo.MRN_MASTER MRN
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM  dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM  dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID
            WHERE MRN.ITEM_CATEGORY_ID = @categoryId AND Cast(CONVERT(date, MRN.CREATED_DATETIME) as varchar(200)) LIKE '%'+@searchText+'%'
            ORDER BY MRN.MRN_ID DESC
		END
		ELSE IF (@categoryId = 0 AND @subDepartmentId > 0)
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID 
            WHERE  MRN.SUB_DEPARTMENT_ID = @subDepartmentId AND Cast(CONVERT(date, MRN.CREATED_DATETIME) as varchar(200)) LIKE '%'+@searchText+'%'
            ORDER BY MRN.MRN_ID DESC
		END
		ELSE IF (@categoryId != 0 AND @subDepartmentId != 0)
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN 
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID
            WHERE Cast(CONVERT(date, MRN.CREATED_DATETIME) as varchar(200)) LIKE '%'+@searchText+'%' AND  MRN.SUB_DEPARTMENT_ID = @subDepartmentId AND  MRN.ITEM_CATEGORY_ID = @categoryId
            ORDER BY MRN.MRN_ID DESC
		END
		ELSE
		BEGIN
			SELECT * FROM dbo.MRN_MASTER MRN
            INNER JOIN (SELECT USER_ID,FIRST_NAME AS USER_NAME FROM dbo.COMPANY_LOGIN) AS CL ON MRN.CREATED_BY = CL.USER_ID
            INNER JOIN (SELECT SUB_DEPARTMENT_ID,DEPARTMENT_NAME FROM dbo.SUB_DEPARTMENT) AS SUBDEP ON MRN.SUB_DEPARTMENT_ID= SUBDEP.SUB_DEPARTMENT_ID
            WHERE Cast(CONVERT(date, MRN.CREATED_DATETIME) as varchar(200)) LIKE '%'+@searchText+'%' 
            ORDER BY MRN.MRN_ID DESC
		END
	END
END
